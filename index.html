<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Cable Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f8ff;
            border-left: 5px solid #4CAF50;
        }
        .iteration {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Enhanced IEC 60364-5-52 Cable Calculator</h1>
        
        <div class="form-group">
            <label for="loadCurrent">Load Current (A):</label>
            <input type="number" id="loadCurrent" value="2079">
        </div>
        
        <div class="form-group">
            <label for="installationMethod">Installation Method:</label>
            <select id="installationMethod">
                <option value="D2" selected>D2 - Sheathed cables direct in ground</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="cableType">Cable Type:</label>
            <select id="cableType">
                <option value="XLPE_3" selected>XLPE/EPR insulation, three loaded conductors</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="conductorMaterial">Conductor Material:</label>
            <select id="conductorMaterial">
                <option value="copper" selected>Copper</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="cableSize">Cable Size (mm²):</label>
            <select id="cableSize">
                <option value="240" selected>240</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="groundTemp">Ground Temperature (°C):</label>
            <select id="groundTemp">
                <option value="20" selected>20</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="soilResistivity">Soil Thermal Resistivity (K·m/W):</label>
            <select id="soilResistivity">
                <option value="2.5" selected>2.5</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="cableClearance">Cable Clearance (for methods D1/D2):</label>
            <select id="cableClearance">
                <option value="1d" selected>1× cable diameter</option>
            </select>
        </div>
        
        <button onclick="calculate()">Calculate</button>
        
        <div id="result" class="result" style="display:none;">
            <h2>Results</h2>
            <p><strong>Selected Cable Capacity:</strong> <span id="selectedCapacity"></span> A</p>
            <p><strong>After Temperature Correction:</strong> <span id="tempCorrectedCapacity"></span> A</p>
            <p><strong>After Soil Resistivity Correction:</strong> <span id="soilCorrectedCapacity"></span> A</p>
            <p><strong>Final Grouping Reduction Factor:</strong> <span id="finalGroupFactor"></span></p>
            <p><strong>Final Cable Capacity After Grouping:</strong> <span id="finalCapacity"></span> A</p>
            <p><strong>Number of Cables Required:</strong> <span id="cablesRequired"></span></p>
            <p><strong>Total Capacity:</strong> <span id="totalCapacity"></span> A</p>
            
            <div id="iterationSteps"></div>
        </div>
        
        <h2>Reference Table B.52.18</h2>
        <table>
            <tr>
                <th>Number of circuits</th>
                <th>Touching</th>
                <th>1× cable diameter</th>
                <th>0.125 m</th>
                <th>0.25 m</th>
                <th>0.5 m</th>
            </tr>
            <tr><td>2</td><td>0.75</td><td>0.80</td><td>0.85</td><td>0.90</td><td>0.90</td></tr>
            <tr><td>3</td><td>0.65</td><td>0.70</td><td>0.75</td><td>0.80</td><td>0.85</td></tr>
            <tr><td>4</td><td>0.60</td><td>0.60</td><td>0.70</td><td>0.75</td><td>0.80</td></tr>
            <tr><td>5</td><td>0.55</td><td>0.55</td><td>0.65</td><td>0.70</td><td>0.80</td></tr>
            <tr><td>6</td><td>0.50</td><td>0.55</td><td>0.60</td><td>0.70</td><td>0.80</td></tr>
            <tr><td>7</td><td>0.45</td><td>0.51</td><td>0.59</td><td>0.67</td><td>0.76</td></tr>
            <tr><td>8</td><td>0.43</td><td>0.48</td><td>0.57</td><td>0.65</td><td>0.75</td></tr>
            <tr><td>9</td><td>0.41</td><td>0.46</td><td>0.55</td><td>0.63</td><td>0.74</td></tr>
            <tr><td>12</td><td>0.36</td><td>0.42</td><td>0.51</td><td>0.59</td><td>0.71</td></tr>
            <tr><td>16</td><td>0.32</td><td>0.38</td><td>0.47</td><td>0.56</td><td>0.38</td></tr>
            <tr><td>20</td><td>0.29</td><td>0.35</td><td>0.44</td><td>0.53</td><td>0.66</td></tr>
        </table>
    </div>

    <script>
        // Cable capacity data (simplified for this example)
        const cableData = {
            'XLPE_3': {
                'copper': {
                    'D2': [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 375, null]
                }
            }
        };
        
        // Direct burial reduction factors (Table B.52.18)
        const burialReduction = {
            'touching': [0.75, 0.65, 0.60, 0.55, 0.50, 0.45, 0.43, 0.41, 0.36, 0.32, 0.29],
            '1d': [0.80, 0.70, 0.60, 0.55, 0.55, 0.51, 0.48, 0.46, 0.42, 0.38, 0.35],
            '0.125m': [0.85, 0.75, 0.70, 0.65, 0.60, 0.59, 0.57, 0.55, 0.51, 0.47, 0.44],
            '0.25m': [0.90, 0.80, 0.75, 0.70, 0.70, 0.67, 0.65, 0.63, 0.59, 0.56, 0.53],
            '0.5m': [0.90, 0.85, 0.80, 0.80, 0.80, 0.76, 0.75, 0.74, 0.71, 0.38, 0.66]
        };
        
        // Standard circuit numbers for interpolation
        const standardCircuits = [2, 3, 4, 5, 6, 7, 8, 9, 12, 16, 20];
        
        // Function to interpolate reduction factor
        function interpolateReductionFactor(circuits, clearance) {
            const factors = burialReduction[clearance];
            
            // If exact match exists
            const exactIndex = standardCircuits.indexOf(circuits);
            if (exactIndex !== -1) {
                return factors[exactIndex];
            }
            
            // Find the bracketing values
            let lowerIndex = -1;
            let upperIndex = -1;
            
            for (let i = 0; i < standardCircuits.length; i++) {
                if (standardCircuits[i] < circuits) {
                    lowerIndex = i;
                } else {
                    upperIndex = i;
                    break;
                }
            }
            
            // Handle edge cases
            if (lowerIndex === -1) {
                return factors[0]; // Below minimum, return first value
            }
            if (upperIndex === -1) {
                return factors[factors.length - 1]; // Above maximum, return last value
            }
            
            // Linear interpolation
            const lowerCircuits = standardCircuits[lowerIndex];
            const upperCircuits = standardCircuits[upperIndex];
            const lowerFactor = factors[lowerIndex];
            const upperFactor = factors[upperIndex];
            
            const weight = (circuits - lowerCircuits) / (upperCircuits - lowerCircuits);
            return lowerFactor + (upperFactor - lowerFactor) * weight;
        }
        
        // Calculate button handler
        function calculate() {
            // Get input values
            const loadCurrent = parseFloat(document.getElementById('loadCurrent').value);
            const method = document.getElementById('installationMethod').value;
            const cableType = document.getElementById('cableType').value;
            const conductor = document.getElementById('conductorMaterial').value;
            const cableSize = parseFloat(document.getElementById('cableSize').value);
            const groundTemp = document.getElementById('groundTemp').value;
            const soilResistivity = document.getElementById('soilResistivity').value;
            const cableClearance = document.getElementById('cableClearance').value;
            
            if (isNaN(loadCurrent)) {
                alert('Please enter a valid load current');
                return;
            }
            
            // Get base capacity from tables
            const sizes = [1.5, 2.5, 4, 6, 10, 16, 25, 35, 50, 70, 95, 120, 150, 185, 240, 300];
            const sizeIndex = sizes.indexOf(cableSize);
            const baseCapacity = cableData[cableType][conductor][method][sizeIndex];
            
            if (baseCapacity === null || baseCapacity === undefined) {
                alert('Selected combination not available in the standard');
                return;
            }
            
            // Apply temperature correction (simplified - factor 1.0 for 20°C)
            const tempCorrectedCapacity = baseCapacity * 1.0;
            
            // Apply soil resistivity correction (simplified - factor 1.0 for 2.5 K·m/W)
            const soilCorrectedCapacity = tempCorrectedCapacity * 1.0;
            
            // Iterative calculation for grouping
            let iterationSteps = '';
            let cablesRequired = 1;
            let finalCapacity = soilCorrectedCapacity;
            let groupReductionFactor = 1;
            let previousCables = 0;
            let iterations = 0;
            const maxIterations = 10;
            
            // Start with 1 cable and iterate until stable
            do {
                previousCables = cablesRequired;
                
                // Get grouping reduction factor with interpolation
                groupReductionFactor = interpolateReductionFactor(cablesRequired, cableClearance);
                
                // Calculate new capacity with grouping
                finalCapacity = soilCorrectedCapacity * groupReductionFactor;
                
                // Calculate new number of cables required
                cablesRequired = Math.ceil(loadCurrent / finalCapacity);
                
                // Record iteration step
                iterationSteps += `
                    <div class="iteration">
                        <strong>Iteration ${iterations + 1}:</strong><br>
                        - Cables in group: ${previousCables}<br>
                        - Group reduction factor: ${groupReductionFactor.toFixed(3)}<br>
                        - Capacity per cable: ${finalCapacity.toFixed(1)} A<br>
                        - Calculated cables required: ${cablesRequired}<br>
                    </div>
                `;
                
                iterations++;
                
                // Prevent infinite loops
                if (iterations >= maxIterations) {
                    iterationSteps += `<div class="iteration"><strong>Maximum iterations reached (${maxIterations})</strong></div>`;
                    break;
                }
                
            } while (cablesRequired !== previousCables);
            
            const totalCapacity = cablesRequired * finalCapacity;
            
            // Display results
            document.getElementById('selectedCapacity').textContent = baseCapacity.toFixed(1);
            document.getElementById('tempCorrectedCapacity').textContent = tempCorrectedCapacity.toFixed(1);
            document.getElementById('soilCorrectedCapacity').textContent = soilCorrectedCapacity.toFixed(1);
            document.getElementById('finalGroupFactor').textContent = groupReductionFactor.toFixed(3);
            document.getElementById('finalCapacity').textContent = finalCapacity.toFixed(1);
            document.getElementById('cablesRequired').textContent = cablesRequired;
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
            
            document.getElementById('iterationSteps').innerHTML = iterationSteps;
            document.getElementById('result').style.display = 'block';
        }
    </script>
</body>
</html>
